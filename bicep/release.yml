parameters:
- name: 'serviceConnection'
  default: ''
- name: 'doEnvironment'
  default: ''

jobs:
- deployment: deploy
  displayName: Infrastructure deploy
  pool:
    vmImage: 'windows-latest'
  timeoutInMinutes: 180
  environment: ${{ parameters.doEnvironment }} 
  strategy:
      runOnce:
        deploy:
          steps:
            - checkout: infrastructure-bicep
            - task: AzureCLI@2
              inputs:
                azureSubscription: '${{ parameters.serviceConnection }}'
                scriptType: 'bash'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  az deployment group create \
                  --resource-group rg-mballon \
                  --template-file "$(System.DefaultWorkingDirectory)"/bicep/main.bicep